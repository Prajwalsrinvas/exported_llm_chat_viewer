<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Chat Explorer</title>
  <meta name="description" content="LLM Chat Explorer is a web application that allows you to view and analyze conversation exports from ChatGPT and Claude, offering an intuitive interface to manage chat history.">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-light: #eff6ff;
      --primary-dark: #1d4ed8;
      --text-color: #1f2937;
      --text-light: #6b7280;
      --sidebar-bg: #f9fafb;
      --content-bg: #ffffff;
      --border-color: #e5e7eb;
      --hover-color: #f3f4f6;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 8px;
      --radius-lg: 12px;
      --highlight-bg: rgba(37, 99, 235, 0.1);
    }
    
    /* Dark mode override */
    body.dark-mode {
      --primary-color: #3b82f6;
      --primary-light: #1e293b;
      --primary-dark: #2563eb;
      --text-color: #f1f5f9;
      --text-light: #94a3b8;
      --sidebar-bg: #0f172a;
      --content-bg: #1e293b;
      --border-color: #334155;
      --hover-color: #334155;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --highlight-bg: rgba(59, 130, 246, 0.2);
    }

    body.dark-mode pre {
        background-color: #2b2b2b !important;
        color: #f8f8f2 !important;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: var(--text-color);
      background-color: var(--content-bg);
      line-height: 1.6;
      transition: all 0.3s ease;
      font-size: 14px;
      letter-spacing: 0.01em;
    }
    
    /* Upload wrapper to vertically center */
    #upload-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 20px;
      position: relative;
    }
    
    /* Dark mode toggle on landing page */
    #landing-dark-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    
    /* Upload area: smaller with border and centered */
    #upload-area {
      cursor: pointer;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
      padding: 48px 32px;
      text-align: center;
      max-width: 480px;
      width: 100%;
      transition: all 0.3s ease;
      background-color: var(--content-bg);
      box-shadow: var(--shadow);
    }
    #upload-area.hover {
      background-color: var(--primary-light);
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    /* Upload title with inline icon */
    .upload-title {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      color: var(--primary-color);
      margin-bottom: 20px;
      white-space: nowrap;
    }
    .upload-title i {
      font-size: 1.8rem;
    }
    /* General text inside #upload-area */
    #upload-area p {
      font-size: 1.2rem;
      color: var(--text-color);
    }

    /* Smaller text for description */
    #upload-area p.small-text {
      font-size: 0.8rem;
    }

    /* Default style for instruction text */
    #upload-area p.upload-instruction {
      font-size: 1rem;  /* Font size */
      color: var(--text-color); /* Use theme variable */
      margin-top: 10px;  /* Space above */
      text-align: center; /* Centered text */
      line-height: 1.5; /* Improve readability */
    }
    
    /* Progress bar */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: #eee;
      z-index: 9999;
      display: none;
    }
    #loading-bar {
      height: 100%;
      width: 0%;
      background-color: var(--primary-color);
      transition: width 0.2s;
    }
    
    /* App container */
    .app-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    .sidebar {
      width: 360px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-header h1 {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem; /* 1.5rem */
      color: var(--primary-color);
      white-space: nowrap;
    }
    
    #chat-counter {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-light);
      padding: 5px 20px; /* 20px left and right */
    }

    .chat-info {
      display: flex;
      align-items: center;
      gap: 5px; /* Space between icon and text */
    }

    /* Gear icon to open settings */
    #open-settings {
      cursor: pointer;
      font-size: 0.9rem;
    }

    
    .search-container {
      position: relative;
      margin: 15px 20px;
    }

    .search-options {
      position: relative;
      margin: 1px 20px;
      font-size: 0.8rem;
      padding: 0px 0px 10px 0px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    #search-bar, #project-search {
      width: 100%;
      padding: 12px 40px 12px 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 14px;
      transition: all 0.2s ease;
      background-color: var(--content-bg);
      color: var(--text-color);
    }
    
    #search-bar:focus, #project-search:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--highlight-bg);
    }
    
    .clear-search {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--text-color);
      cursor: pointer;
      display: none;
      width: 18px;
      height: 18px;
      line-height: 18px;
      text-align: center;
      border: none;
      border-radius: 50%;
      background-color: #d3d3d3;
    }
    .clear-search:hover {
      background-color: #c0c0c0;
      color: var(--primary-color);
    }
    
    .chat-list {
      list-style: none;
      overflow-y: auto;
      flex-grow: 1;
      padding: 10px;
      max-height: calc(100vh - 250px);
      scrollbar-width: thin;
    }
    
    .chat-list li {
      padding: 14px 16px;
      margin-bottom: 6px;
      cursor: pointer;
      border-radius: var(--radius);
      transition: all 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 3px solid transparent;
      font-size: 14px;
    }
    
    .chat-list li:hover {
      background-color: var(--hover-color);
      border-left-color: var(--primary-color);
      transform: translateX(2px);
    }
    
    .chat-list li.active {
      background-color: var(--primary-light);
      border-left-color: var(--primary-color);
      font-weight: 600;
      box-shadow: var(--shadow);
    }
    
    .chat-date {
      color: var(--text-light);
      font-size: 0.8rem;
      margin-left: 5px;
      opacity: 0.7;
    }
    
    .content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--content-bg);
      box-shadow: var(--shadow);
    }
    
    .content-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .external-link {
      display: inline-flex;
      align-items: center;
      gap: 5px; /* Set a 5px space between icon and text */
      color: var(--primary-color);
      text-decoration: none;
      font-size: 14px;
      transition: opacity 0.2s;
      padding: 6px 12px;
      border-radius: var(--radius);
      background-color: var(--primary-light);
    }
    /* In dark mode, the link text becomes white */
    body.dark-mode .external-link {
      color: #ffffff;
    }
    /* In dark mode, the text typed in the search field will be the variable like --text-color(#f0f0f0) instead of plain white */
    body.dark-mode #search-bar {
      color: var(--text-color);
    }
    body.dark-mode .clear-search {
      color: #333; /* Dark color for the X in dark mode */
    }

    .external-link:hover {
      opacity: 0.8;
    }
    
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px 30px;
      background-color: var(--content-bg);
    }
    
    .message {
      margin-bottom: 24px;
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      position: relative;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    
    .message:hover {
      box-shadow: var(--shadow-lg);
    }
    
    .message-user {
      background-color: var(--primary-light);
      margin-left: 60px;
      border-left: 4px solid var(--primary-color);
    }
    
    .message-assistant {
      background-color: var(--sidebar-bg);
      margin-right: 60px;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 12px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .sender {
      font-weight: 600;
      font-size: 14px;
    }
    
    .message-content {
      line-height: 1.6;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-light);
      text-align: center;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 20px;
    }
    
    .empty-state p {
      font-size: 1.1rem;
    }
    
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: 50vh;
        min-height: 200px;
      }
      
      .content {
        height: 50vh;
      }
    }
    
    /* ---------- Settings modal ---------- */
    #settings-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    #settings-modal .modal-content {
      background-color: var(--content-bg);
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    #settings-modal h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }
    .close-button {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .setting-item span.label {
      font-size: 1rem;
      color: var(--text-color);
    }
    /* Generic switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--primary-color);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    /* Switch for dark mode with icons (corrected for better alignment) */
    .dark-slider:before {
    content: "\f185"; /* sun */
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    position: absolute;
    top: 3px;
    left: 6px;
    font-size: 18px;
    color: #f39c12;
    }

    input:checked + .dark-slider:before {
    content: "\f186"; /* moon */
    left: auto;
    right: 30px;
    top: 3px;
    color: #f1c40f;
    }
    
    /* Class to highlight searched text; uses the color defined by --highlight-bg, which changes dynamically based on the theme (light/dark mode). */
    .highlight {
      background-color: var(--highlight-bg);
      font-weight: bold;
    }

    /* Thinking content styles */
    .thinking-section {
      margin-top: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      background-color: #f8f9fa;
      overflow: hidden;
    }

    body.dark-mode .thinking-section {
      border-color: #444;
      background-color: #2a2a2a;
    }

    .thinking-toggle {
      padding: 8px 12px;
      background-color: #f0f0f0;
      border: none;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      font-size: 0.9rem;
      color: #666;
      display: flex;
      align-items: center;
      gap: 5px;
      width: 100%;
      text-align: left;
    }

    body.dark-mode .thinking-toggle {
      background-color: #333;
      border-bottom-color: #444;
      color: #aaa;
    }

    .thinking-toggle:hover {
      background-color: #e8e8e8;
    }

    body.dark-mode .thinking-toggle:hover {
      background-color: #3a3a3a;
    }

    .thinking-content {
      padding: 12px;
      font-size: 0.85rem;
      color: #555;
      line-height: 1.4;
      border-top: 1px solid #e0e0e0;
      display: none;
    }

    body.dark-mode .thinking-content {
      color: #ccc;
      border-top-color: #444;
    }

    .thinking-content.expanded {
      display: block;
    }

    .thinking-icon {
      transition: transform 0.2s ease;
    }

    .thinking-icon.expanded {
      transform: rotate(90deg);
    }

    /* Tab system styles */
    .tab-container {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .tab-button {
      flex: 1;
      padding: 10px 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-light);
      transition: all 0.2s ease;
    }

    .tab-button.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }

    .tab-button:hover {
      background-color: var(--hover-color);
    }

    .tab-content {
      display: none;
      flex-grow: 1;
      flex-direction: column;
    }

    .tab-content.active {
      display: flex;
    }

    /* Projects list styles */
    .project-list {
      list-style: none;
      overflow-y: auto;
      flex-grow: 1;
      padding: 10px;
      max-height: calc(100vh - 250px);
      scrollbar-width: thin;
    }

    .project-item {
      padding: 12px 15px;
      margin-bottom: 5px;
      cursor: pointer;
      border-radius: var(--radius);
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .project-item:hover {
      background-color: var(--hover-color);
      border-left-color: var(--primary-color);
    }

    .project-item.active {
      background-color: var(--primary-light);
      border-left-color: var(--primary-color);
      font-weight: 500;
    }

    .project-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .project-description {
      font-size: 0.8rem;
      color: var(--text-light);
      opacity: 0.8;
    }

    .project-date {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 4px;
    }

    /* Scrollbar styling for webkit browsers */
    .chat-list::-webkit-scrollbar,
    .project-list::-webkit-scrollbar {
      width: 6px;
    }

    .chat-list::-webkit-scrollbar-track,
    .project-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-list::-webkit-scrollbar-thumb,
    .project-list::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .chat-list::-webkit-scrollbar-thumb:hover,
    .project-list::-webkit-scrollbar-thumb:hover {
      background: var(--text-light);
    }
</style>
</head>
<body>
  <!-- Progress bar -->
  <div id="loading-overlay">
    <div id="loading-bar"></div>
  </div>

  <!-- Upload wrapper to center the upload area -->
  <div id="upload-wrapper">
    <!-- Dark mode toggle for landing page -->
    <div id="landing-dark-toggle">
      <span>Dark mode:</span>
      <label class="switch">
        <input type="checkbox" id="landing-dark-toggle-input">
        <span class="slider dark-slider"></span>
      </label>
    </div>
    
    <div id="upload-area">
      <h1 class="upload-title"><i class="fas fa-comments"></i> <span>LLM Chat Explorer</span></h1>
      <p class="small-text">
        Upload the export of your chat data from ChatGPT or Claude to view and analyze conversations in an intuitive and user-friendly interface.
      </p>
      </br>
      <p class="upload-instruction">Drag and drop JSON or ZIP files or click to select</p>
      <input type="file" id="json-file" accept=".json,.zip" multiple style="display: none;">
    </div>
  </div>

  <!-- Main app (hidden until JSON is loaded) -->
  <div class="app-container" style="display: none;">
    <div class="sidebar">
      <div class="sidebar-header">
        <h1 style="cursor: pointer;" onclick="location.reload();" title="Click here to reload the page"><i class="fas fa-comments"></i> LLM Chat Explorer</h1>
      </div>
      <div id="chat-counter">
        <div class="chat-info">
          <i class="fas fa-chart-bar"></i>
          <span id="chat-counter-text">0 chats total</span>
        </div>
        <div id="service-label" style="margin-left: 10px; font-size: 0.9rem; color: var(--text-light);">
          Source:
        </div>
        <div id="open-settings" title="Open settings">
          <i class="fas fa-gear"></i>
        </div>
      </div>
      
      <!-- Tab system -->
      <div class="tab-container">
        <button class="tab-button active" id="conversations-tab">
          <i class="fas fa-comments"></i> Conversations
        </button>
        <button class="tab-button" id="projects-tab">
          <i class="fas fa-folder"></i> Projects
        </button>
      </div>
      
      <!-- Conversations tab content -->
      <div id="conversations-content" class="tab-content active">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="search-bar" placeholder="Search conversations...">
          <span id="clear-search" class="clear-search">&times;</span>
        </div>
        <div class="search-options">
          <input type="checkbox" id="search-content-toggle">
          <label for="search-content-toggle">Search within message content</label>
        </div>
        <ul id="chat-list" class="chat-list">
          <!-- Chat titles will be inserted here -->
        </ul>
      </div>
      
      <!-- Projects tab content -->
      <div id="projects-content" class="tab-content">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="project-search" placeholder="Search projects...">
          <span id="clear-project-search" class="clear-search">&times;</span>
        </div>
        <ul id="project-list" class="project-list">
          <!-- Projects will be inserted here -->
        </ul>
      </div>
    </div>
    <div class="content">
      <div class="content-header">
      <div style="display:inline-flex; align-items:center; gap:6px;">
        <h2 id="chat-title" style="margin:0;">Select a chat</h2>
        <button id="share-button" title="Share chat" style="background:none; border:none; cursor:pointer;">
          <i class="fas fa-share"></i>
        </button>
      </div>
      <a id="chat-link" href="#" target="_blank" class="external-link" style="display: none;">
        <i class="fas fa-external-link-alt"></i> View on 
      </a>
      </div>
      <div id="chat-content" class="chat-messages">
      <div class="empty-state">
        <i class="fas fa-hand-point-left"></i>
        <p>Select a conversation from the list to view it</p>
      </div>
      </div>
    </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Settings</h2>
      <div class="setting-item">
      <span class="label" id="dark-mode-label">Dark mode:</span>
      <label class="switch">
        <input type="checkbox" id="modal-dark-toggle">
        <span class="slider dark-slider"></span>
      </label>
      </div>
      <div class="setting-item">
      <span class="label" id="chat-position-label">Chat position:</span>
      <label class="switch">
        <input type="checkbox" id="modal-chat-toggle" checked>
        <span class="slider"></span>
      </label>
      <span id="chat-position-text">At end</span>
      </div>
    </div>
    </div>

  <script>

    // Function to format the date in dd/mm/yyyy format
    function formatDate(date) {
      const d = new Date(date);
      const day = ('0' + d.getDate()).slice(-2);
      const month = ('0' + (d.getMonth() + 1)).slice(-2);
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function processData(data) {
      let conversations = [];
      if (Array.isArray(data)) {
      conversations = data;
      } else {
      conversations = data.conversations || [];
      }

      // If the file is in Claude format (i.e., if the first object contains the property chat_messages), the order is from oldest to newest.
      // Reverse the array to have the same order (from most recent to oldest) as ChatGPT to normalize the chat flow display.
      if (conversations.length > 0 && conversations[0].chat_messages) {
      conversations.reverse();
      }

      // Save the original total globally for reference
      window.originalTotalChats = conversations.length;

      let chatListHTML = '';
      const chatData = {};
      let displayedChatIndex = 0;

      conversations.forEach((chat, originalIndex) => {
      // Skip chats with empty names - don't consider chats having "name": ""
      if ((chat.title === "" || chat.title === null || chat.title === undefined) && 
          (chat.name === "" || chat.name === null || chat.name === undefined)) {
        return; // Skip this chat
      }
      
      // Use 'title' (ChatGPT) or 'name' (Claude) for the title
      let title = chat.title || chat.name || `Chat ${displayedChatIndex + 1}`;
      let messages = [];
      let service = "ChatGPT"; // default
      let uuid = null;
      let conversation_id = null;

      // If the format is Claude (field "chat_messages")
      if (chat.chat_messages) {
        service = "Claude";
        uuid = chat.uuid; // from Claude
        chat.chat_messages.forEach((msg) => {
        // Map the role based on the sender field
        let role = "";
        if (msg.sender) {
          role = msg.sender === "human" ? "user" : "assistant";
        } else {
          role = "assistant"; // default
        }
        
        // For Claude messages, store the full message object for thinking content
        const messageObj = {
          text: msg.text || '',
          role: role,
          content: msg.content || [],
          isClaudeMessage: true
        };
        messages.push(messageObj);
        });
      }
      // If the format is ChatGPT with mapping
      else if (chat.mapping) {
        if (chat.conversation_id) {
        conversation_id = chat.conversation_id;
        }
        for (let key in chat.mapping) {
        const messageObj = chat.mapping[key];
        if (messageObj.message && messageObj.message.content) {
          // Extract the role from the author.role field (default to "assistant" if not present)
          const role = messageObj.message.author && messageObj.message.author.role ? messageObj.message.author.role : "assistant";
          const parts = messageObj.message.content.parts || [];
          parts.forEach((part) => {
          if (typeof part === 'string' && part.trim() !== '') {
            messages.push({ text: part, role: role });
          }
          });
        }
        }
      }

      // Handle creation date (Claude uses "created_at")
      let createdTime = null;
      if (chat.created_at) {
        createdTime = new Date(chat.created_at);
      } else if (chat.create_time) {
        createdTime = typeof chat.create_time === 'number' ? new Date(chat.create_time * 1000) : new Date(chat.create_time);
      }

      let displayTitle = title;
      if (createdTime) {
        displayTitle += ` <span class='chat-date'>${formatDate(createdTime)}</span>`;
      }
      chatListHTML += `<li data-id="${displayedChatIndex}" title="${title}">${displayTitle}</li>`;
      chatData[displayedChatIndex] = {
        title: title,
        messages: messages,
        created_time: createdTime ? formatDate(createdTime) : "",
        service: service,
        uuid: uuid,
        conversation_id: conversation_id
      };
      displayedChatIndex++;
      });

      // Update the total chats count to reflect displayed chats
      window.totalChats = displayedChatIndex;
      
      document.getElementById("chat-list").innerHTML = chatListHTML;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
      li.setAttribute("data-original", li.innerHTML);
      });
      if (conversations.length > 0) {
      // If the first object contains "chat_messages", the file is from Claude, otherwise ChatGPT
      let serviceType = (conversations[0].chat_messages) ? "Claude" : "ChatGPT";
      window.currentService = serviceType; // Save the service globally
      document.getElementById("service-label").textContent = "Source: " + serviceType;
      }
      const searchBar = document.getElementById("search-bar");
      const clearSearch = document.getElementById("clear-search");

      searchBar.addEventListener("input", () => {
      const searchTerm = searchBar.value.toLowerCase().trim();
      clearSearch.style.display = searchTerm !== "" ? "block" : "none";
      const words = searchTerm.split(/\s+/).filter(word => word.length > 0);
      const searchInContent = document.getElementById("search-content-toggle").checked;
      let visibleCount = 0; // variable to count visible chats

      Array.from(document.getElementById("chat-list").children).forEach(li => {
        const chatId = li.getAttribute("data-id");
        const chat = chatData[chatId];
        const titleText = chat.title.toLowerCase();
        // Check the title
        const titleMatches = words.every(word => titleText.includes(word));
        let contentMatches = false;
        if (searchInContent && chat.messages) {
        contentMatches = chat.messages.some(msgObj => {
          return words.every(word => msgObj.text.toLowerCase().includes(word));
        });
        }
        const matches = titleMatches || contentMatches;
        li.style.display = matches ? "" : "none";
        if (matches) {
        visibleCount++;
        // Highlight in the title (if applicable)
        if (titleMatches && words.length > 0) {
          let newHTML = li.getAttribute("data-original");
          words.forEach(word => {
          const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'gi');
          newHTML = newHTML.replace(regex, `<span class="highlight">$1</span>`);
          });
          li.innerHTML = newHTML;
        } else {
          li.innerHTML = li.getAttribute("data-original");
        }
        }
      });
      
      // Update the counter: "visible of total chats total"
      if (visibleCount === window.totalChats) {
        document.getElementById("chat-counter-text").textContent = window.totalChats + " chats total";
      } else {
        document.getElementById("chat-counter-text").textContent = visibleCount + " of " + window.totalChats + " chats total";
      }
      
      // If a chat is active, also update the message content
      const activeLi = document.querySelector(".chat-list li.active");
      if (activeLi) {
        const activeChatId = activeLi.getAttribute("data-id");
        renderMessages(chatData[activeChatId].messages);
      }
      });
      // Add this listener to update the search when the checkbox changes:
      document.getElementById("search-content-toggle").addEventListener("change", () => {
      // Simulate the "input" event on the search field to update the results
      searchBar.dispatchEvent(new Event("input"));
      });
      clearSearch.addEventListener("click", () => {
      searchBar.value = "";
      clearSearch.style.display = "none";
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        li.style.display = "";
        li.innerHTML = li.getAttribute("data-original");
      });
      searchBar.focus();
      // Update the counter to show the total, as the filter has been removed
      document.getElementById("chat-counter-text").textContent = window.totalChats + " chats total";
      });
      document.getElementById("chat-list").addEventListener("click", (event) => {
      const clickedLi = event.target.closest("li");
      if (!clickedLi) return;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        li.classList.remove("active");
      });
      clickedLi.classList.add("active");
      const chatId = clickedLi.getAttribute("data-id");
      const chat = chatData[chatId];
      document.getElementById("chat-title").textContent = chat.title;
      const chatLink = document.getElementById("chat-link");
      if (chat.url) {
        chatLink.href = chat.url;
        chatLink.style.display = "inline-flex";
      } else {
        chatLink.style.display = "none";
      }
      if (chat.messages && chat.messages.length > 0) {
        renderMessages(chat.messages);
      } else {
        document.getElementById("chat-content").innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comment-slash"></i>
          <p>Select a conversation from the list to view it</p>
        </div>`;
      }
      });
      function renderMessages(messages) {
      let html = '';
      messages.forEach((msgObj, msgIndex) => {
        const role = msgObj.role || "assistant"; // fallback
        if (role === "user") {
        html += `
          <div class="message message-user">
          <div class="message-header">
            <div class="avatar" title="User">U</div>
            <span class="sender">You</span>
          </div>
          <div class="message-content">${formatMessage(msgObj.text)}</div>
          </div>`;
        } else {
        html += `
          <div class="message message-assistant">
          <div class="message-header">
            <div class="avatar" title="Assistant" style="background-color: var(--primary-color)">A</div>
            <span class="sender">${window.currentService}</span>
          </div>
          <div class="message-content">
            ${formatMessage(msgObj.text)}
            ${renderThinkingContent(msgObj, msgIndex)}
          </div>
          </div>`;
        }
      });
      document.getElementById("chat-content").innerHTML = html;
      
      // Add click handlers for thinking toggles
      document.querySelectorAll('.thinking-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const content = toggle.nextElementSibling;
          const icon = toggle.querySelector('.thinking-icon');
          
          if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            icon.classList.remove('expanded');
          } else {
            content.classList.add('expanded');
            icon.classList.add('expanded');
          }
        });
      });
      
      const scrollPreference = localStorage.getItem('chatPosition') || 'end';
      const chatContent = document.getElementById("chat-content");
      chatContent.scrollTop = scrollPreference === 'end' ? chatContent.scrollHeight : 0;
      }

      function renderThinkingContent(msgObj, msgIndex) {
        if (!msgObj.isClaudeMessage || !msgObj.content) return '';
        
        // Find thinking content
        const thinkingContent = msgObj.content.find(c => c.type === 'thinking');
        if (!thinkingContent) return '';
        
        return `
          <div class="thinking-section">
            <button class="thinking-toggle">
              <i class="fas fa-chevron-right thinking-icon"></i>
              ðŸ’­ Show Thinking
            </button>
            <div class="thinking-content">
              ${formatMessage(thinkingContent.thinking || '')}
            </div>
          </div>
        `;
      }
      function formatMessage(text) {
      if (!text) return '';
      // Convert links and code blocks
      text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--primary-color);">$1</a>');
      text = text.replace(/```([^`]+)```/g, '<pre style="background-color: #f6f8fa; padding: 1em; border-radius: 5px; overflow-x: auto;">$1</pre>');
      text = text.replace(/\n/g, '<br>');
      
      // Highlight searched words in the content if the checkbox is active
      const searchTerm = document.getElementById("search-bar").value.toLowerCase().trim();
      const searchInContent = document.getElementById("search-content-toggle") && document.getElementById("search-content-toggle").checked;
      if (searchTerm && searchInContent) {
        const words = searchTerm.split(/\s+/).filter(word => word.length > 0);
        words.forEach(word => {
        const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'gi');
        text = text.replace(regex, `<span class="highlight">$1</span>`);
        });
      }
      return text;
      }
    
      // Update the chat counter if defined
      document.getElementById("chat-counter-text").textContent = window.totalChats + " chats total";

      attachChatListClickHandler(chatData);
    }

    function attachChatListClickHandler(chatData) {
      document.getElementById("chat-list").addEventListener("click", (event) => {
      const clickedLi = event.target.closest("li");
      if (!clickedLi) return;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        li.classList.remove("active");
      });
      clickedLi.classList.add("active");
      const chatId = clickedLi.getAttribute("data-id");
      const chat = chatData[chatId];
      document.getElementById("chat-title").textContent = chat.title;
      const chatLink = document.getElementById("chat-link");

      // Only show the link if there are messages
      if (chat.messages && chat.messages.length > 0) {
        if (chat.service === "Claude" && chat.uuid) {
        chatLink.href = "https://claude.ai/chat/" + chat.uuid;
        chatLink.innerHTML = '<i class="fas fa-external-link-alt"></i> View on Claude';
        chatLink.style.display = "inline-flex";
        } else if (chat.service === "ChatGPT" && chat.conversation_id) {
        chatLink.href = "https://chat.openai.com/c/" + chat.conversation_id;
        chatLink.innerHTML = '<i class="fas fa-external-link-alt"></i> View on ChatGPT';
        chatLink.style.display = "inline-flex";
        } else {
        chatLink.style.display = "none";
        }
      } else {
        chatLink.style.display = "none";
      }

      if (chat.messages && chat.messages.length > 0) {
        renderMessages(chat.messages);
      } else {
        document.getElementById("chat-content").innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comment-slash"></i>
          <p>Select a conversation from the list to view it</p>
        </div>`;
      }
      });
    }

    // Process ZIP file and extract JSON files
    async function processZipFile(file) {
      try {
        const zip = new JSZip();
        const zipContents = await zip.loadAsync(file);
        
        let conversations = [];
        let projects = [];
        
        // Look for conversations.json and projects.json files
        for (const filename in zipContents.files) {
          const zipFile = zipContents.files[filename];
          
          if (filename.endsWith('conversations.json') && !zipFile.dir) {
            const content = await zipFile.async('text');
            const data = JSON.parse(content);
            if (Array.isArray(data)) {
              conversations = conversations.concat(data);
            } else {
              conversations.push(data);
            }
          } else if (filename.endsWith('projects.json') && !zipFile.dir) {
            const content = await zipFile.async('text');
            const data = JSON.parse(content);
            if (Array.isArray(data)) {
              projects = projects.concat(data);
            } else {
              projects.push(data);
            }
          }
        }
        
        return { conversations, projects };
      } catch (e) {
        throw new Error("Error processing ZIP file: " + e.message);
      }
    }

    // Handle the uploaded files (via input or drag & drop)
    async function handleFiles(files) {
      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingBar = document.getElementById('loading-bar');
      loadingOverlay.style.display = 'block';
      
      try {
        let allConversations = [];
        let allProjects = [];
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          loadingBar.style.width = Math.floor((i / files.length) * 100) + '%';
          
          if (file.name.endsWith('.zip')) {
            const { conversations, projects } = await processZipFile(file);
            allConversations = allConversations.concat(conversations);
            allProjects = allProjects.concat(projects);
          } else if (file.name.endsWith('.json')) {
            const text = await file.text();
            const data = JSON.parse(text);
            
            // Detect format and add to appropriate array
            if (Array.isArray(data)) {
              allConversations = allConversations.concat(data);
            } else if (data.chat_messages) {
              // Single Claude conversation
              allConversations.push(data);
            } else if (data.conversations) {
              // ChatGPT format
              allConversations = allConversations.concat(data.conversations);
            } else {
              // Assume single conversation
              allConversations.push(data);
            }
          }
        }
        
        // Store projects globally for later use
        window.allProjects = allProjects;
        
        document.getElementById('upload-wrapper').style.display = 'none';
        document.querySelector('.app-container').style.display = 'flex';
        loadingOverlay.style.display = 'none';
        
        processData(allConversations);
        renderProjects();
        
      } catch (e) {
        alert("File processing error: " + e.message);
        loadingOverlay.style.display = 'none';
      }
    }

    // Tab switching functionality
    function switchTab(tabName) {
      // Remove active class from all tabs and content
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked tab and corresponding content
      document.getElementById(tabName + '-tab').classList.add('active');
      document.getElementById(tabName + '-content').classList.add('active');
    }

    // Render projects list
    function renderProjects() {
      const projectList = document.getElementById('project-list');
      if (!window.allProjects || window.allProjects.length === 0) {
        projectList.innerHTML = '<li style="padding: 20px; text-align: center; color: var(--text-light);">No projects found</li>';
        return;
      }
      
      let html = '';
      window.allProjects.forEach((project, index) => {
        const name = project.name || `Project ${index + 1}`;
        const description = project.description || '';
        const createdDate = project.created_at ? formatDate(new Date(project.created_at)) : '';
        
        html += `
          <li class="project-item" data-project-id="${index}">
            <div class="project-name">${name}</div>
            ${description ? `<div class="project-description">${description}</div>` : ''}
            ${createdDate ? `<div class="project-date">${createdDate}</div>` : ''}
          </li>
        `;
      });
      
      projectList.innerHTML = html;
      
      // Store original HTML for search functionality
      Array.from(projectList.children).forEach(li => {
        li.setAttribute("data-original", li.innerHTML);
      });
      
      // Add click handlers for projects
      projectList.addEventListener('click', (e) => {
        const projectItem = e.target.closest('.project-item');
        if (!projectItem) return;
        
        // Remove active class from other projects
        document.querySelectorAll('.project-item').forEach(item => item.classList.remove('active'));
        projectItem.classList.add('active');
        
        const projectId = projectItem.getAttribute('data-project-id');
        displayProject(window.allProjects[projectId]);
      });
      
      // Add project search functionality
      setupProjectSearch();
    }

    // Display project details in the main content area
    function displayProject(project) {
      const chatTitle = document.getElementById('chat-title');
      const chatContent = document.getElementById('chat-content');
      const chatLink = document.getElementById('chat-link');
      
      chatTitle.textContent = project.name || 'Project';
      chatLink.style.display = 'none';
      
      let html = `
        <div style="padding: 20px;">
          <h3>Project: ${project.name || 'Unnamed Project'}</h3>
          ${project.description ? `<p style="margin: 10px 0; color: var(--text-light);">${project.description}</p>` : ''}
          ${project.created_at ? `<p style="margin: 10px 0; font-size: 0.9rem; color: var(--text-light);">Created: ${formatDate(new Date(project.created_at))}</p>` : ''}
          
          ${project.prompt_template ? `
            <div style="margin: 20px 0;">
              <h4>Prompt Template:</h4>
              <div style="background: var(--sidebar-bg); padding: 15px; border-radius: 5px; margin: 10px 0; white-space: pre-wrap; font-family: monospace;">${project.prompt_template}</div>
            </div>
          ` : ''}
          
          ${project.docs && project.docs.length > 0 ? `
            <div style="margin: 20px 0;">
              <h4>Documents (${project.docs.length}):</h4>
              ${project.docs.map(doc => `
                <div style="border: 1px solid var(--border-color); border-radius: 5px; margin: 10px 0; padding: 15px;">
                  <h5 style="margin: 0 0 10px 0;">${doc.filename || 'Unnamed Document'}</h5>
                  ${doc.created_at ? `<p style="font-size: 0.8rem; color: var(--text-light); margin: 5px 0;">Created: ${formatDate(new Date(doc.created_at))}</p>` : ''}
                  ${doc.content ? `
                    <details style="margin: 10px 0;">
                      <summary style="cursor: pointer; font-weight: 500;">View Content</summary>
                      <div style="margin-top: 10px; padding: 10px; background: var(--sidebar-bg); border-radius: 3px; white-space: pre-wrap; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">${doc.content}</div>
                    </details>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
      
      chatContent.innerHTML = html;
    }

    // Setup project search functionality
    function setupProjectSearch() {
      const projectSearchBar = document.getElementById("project-search");
      const clearProjectSearch = document.getElementById("clear-project-search");
      
      projectSearchBar.addEventListener("input", () => {
        const searchTerm = projectSearchBar.value.toLowerCase().trim();
        clearProjectSearch.style.display = searchTerm !== "" ? "block" : "none";
        const words = searchTerm.split(/\s+/).filter(word => word.length > 0);
        
        Array.from(document.getElementById("project-list").children).forEach(li => {
          const projectId = li.getAttribute("data-project-id");
          if (projectId !== null && window.allProjects && window.allProjects[projectId]) {
            const project = window.allProjects[projectId];
            const nameText = (project.name || '').toLowerCase();
            const descriptionText = (project.description || '').toLowerCase();
            
            // Check if search terms match name or description
            const matches = words.every(word => 
              nameText.includes(word) || descriptionText.includes(word)
            );
            
            li.style.display = matches ? "" : "none";
            
            if (matches && words.length > 0) {
              // Highlight matching terms
              let newHTML = li.getAttribute("data-original");
              words.forEach(word => {
                const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'gi');
                newHTML = newHTML.replace(regex, `<span class="highlight">$1</span>`);
              });
              li.innerHTML = newHTML;
            } else {
              li.innerHTML = li.getAttribute("data-original");
            }
          }
        });
      });
      
      clearProjectSearch.addEventListener("click", () => {
        projectSearchBar.value = "";
        clearProjectSearch.style.display = "none";
        Array.from(document.getElementById("project-list").children).forEach(li => {
          li.style.display = "";
          li.innerHTML = li.getAttribute("data-original");
        });
        projectSearchBar.focus();
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const uploadArea = document.getElementById('upload-area');
      const jsonFileInput = document.getElementById('json-file');
      
      // Tab switching
      document.getElementById('conversations-tab').addEventListener('click', () => switchTab('conversations'));
      document.getElementById('projects-tab').addEventListener('click', () => switchTab('projects'));
      
      uploadArea.addEventListener("click", () => {
      jsonFileInput.click();
      });
      uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add('hover');
      });
      uploadArea.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadArea.classList.remove('hover');
      });
      uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove('hover');
      const files = e.dataTransfer.files;
      if (files.length) {
        handleFiles(Array.from(files));
      }
      });
      jsonFileInput.addEventListener("change", (e) => {
      if (e.target.files.length) {
        handleFiles(Array.from(e.target.files));
      }
      });
      // Modal: close by clicking the X
      document.querySelector("#settings-modal .close-button").addEventListener("click", () => {
      document.getElementById("settings-modal").style.display = "none";
      });
      // Open modal from settings
      document.getElementById("open-settings").addEventListener("click", () => {
      document.getElementById("settings-modal").style.display = "flex";
      });
      // Toggle dark mode in modal
      document.getElementById("modal-dark-toggle").addEventListener("change", (e) => {
      if (e.target.checked) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'true');
        // Sync with landing page toggle if it exists
        const landingToggle = document.getElementById("landing-dark-toggle-input");
        if (landingToggle) landingToggle.checked = true;
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'false');
        // Sync with landing page toggle if it exists
        const landingToggle = document.getElementById("landing-dark-toggle-input");
        if (landingToggle) landingToggle.checked = false;
      }
      });
      // Toggle chat position in modal
      document.getElementById("modal-chat-toggle").addEventListener("change", (e) => {
      if (e.target.checked) {
        localStorage.setItem('chatPosition', 'end');
      } else {
        localStorage.setItem('chatPosition', 'start');
      }
      document.getElementById("chat-position-text").textContent = e.target.checked ? "At end" : "At start";
      // If a chat is already displayed, update the scroll
      const chatContent = document.getElementById("chat-content");
      chatContent.scrollTop = e.target.checked ? chatContent.scrollHeight : 0;
      });
      // Set saved settings from localStorage
      if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById("modal-dark-toggle").checked = true;
      document.getElementById("landing-dark-toggle-input").checked = true;
      }
      if (localStorage.getItem('chatPosition') === 'end') {
      document.getElementById("modal-chat-toggle").checked = true;
      document.getElementById("chat-position-text").textContent = "At end";
      } else {
      document.getElementById("modal-chat-toggle").checked = false;
      document.getElementById("chat-position-text").textContent = "At start";
      }
      
      // Landing page dark mode toggle
      document.getElementById("landing-dark-toggle-input").addEventListener("change", (e) => {
        if (e.target.checked) {
          document.body.classList.add('dark-mode');
          localStorage.setItem('darkMode', 'true');
          // Sync with modal toggle if it exists
          const modalToggle = document.getElementById("modal-dark-toggle");
          if (modalToggle) modalToggle.checked = true;
        } else {
          document.body.classList.remove('dark-mode');
          localStorage.setItem('darkMode', 'false');
          // Sync with modal toggle if it exists
          const modalToggle = document.getElementById("modal-dark-toggle");
          if (modalToggle) modalToggle.checked = false;
        }
      });
    });

    // Event for the share button: copy the chat title + ChatGPT/Claude link to clipboard
    document.getElementById("share-button").addEventListener("click", function() {
      const chatTitle = document.getElementById("chat-title").textContent;
      const chatLink = document.getElementById("chat-link").href;
      // Add a colon and a space between title and link
      const shareText = chatTitle + ": " + chatLink;
      navigator.clipboard.writeText(shareText).then(() => {
        // Create a small light gray message that appears and fades out slowly
        const notification = document.createElement("div");
        notification.id = "copy-notification";
        notification.textContent = "Chat link copied to clipboard!";
        notification.style.position = "fixed";
        //notification.style.bottom = "20px"; // Show the message at the bottom
        notification.style.top = "60px"; // Show the message at the top
        notification.style.left = "50%";
        notification.style.transform = "translateX(-50%)";
        notification.style.backgroundColor = "#ddd";
        notification.style.color = "#333";
        notification.style.padding = "10px 20px";
        notification.style.borderRadius = "4px";
        notification.style.opacity = "0";
        notification.style.transition = "opacity 1s";
        document.body.appendChild(notification);
        // Make the message appear
        setTimeout(() => {
        notification.style.opacity = "1";
        }, 10);
        // After 2 seconds, fade out and remove the element
        setTimeout(() => {
        notification.style.opacity = "0";
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 1000);
        }, 2000);
      }).catch(err => {
        console.error("Error copying information: " + err);
      });
    });
    
  </script>
</body>
</html>

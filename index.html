<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Chat Explorer</title>
  <meta name="description"
    content="LLM Chat Explorer is a web application that allows you to view and analyze conversation exports from ChatGPT and Claude, offering an intuitive interface to manage chat history.">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"
    id="prism-light-theme">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"
    id="prism-dark-theme">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <style>
    /* CSS Custom Properties for sidebar */
    :root {
      --sidebar-width: 360px;
      --sidebar-collapsed-width: 60px;
    }

    /* Enhanced custom scrollbar styles */
    .custom-scrollbar {
      scrollbar-width: thin;
      scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(156, 163, 175, 0.6);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(156, 163, 175, 0.8);
    }

    .custom-scrollbar::-webkit-scrollbar-corner {
      background: transparent;
    }

    .dark .custom-scrollbar {
      scrollbar-color: rgba(75, 85, 99, 0.6) transparent;
    }

    .dark .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(75, 85, 99, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(75, 85, 99, 0.9);
    }

    /* Sidebar collapse animations */
    .sidebar {
      width: var(--sidebar-width);
      transition: width 0.3s ease-in-out;
      min-width: var(--sidebar-collapsed-width);
      flex-shrink: 0;
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
    }

    .sidebar.collapsed .sidebar-content {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-content {
      transition: opacity 0.2s ease-in-out;
      opacity: 1;
      overflow: hidden;
    }

    /* Improved tab content transitions */
    .tab-content {
      transition: none;
      /* Remove transition to prevent width changes */
    }

    .tab-content.hidden {
      display: none !important;
    }

    .sidebar-toggle {
      transition: transform 0.3s ease-in-out;
    }

    .sidebar.collapsed .sidebar-toggle {
      transform: rotate(180deg);
    }

    .collapse-icon {
      min-width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Code block copy button styles */
    .code-block-container {
      position: relative;
    }

    .copy-code-button {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      z-index: 10;
    }

    .copy-code-button:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .code-block-container:hover .copy-code-button {
      opacity: 1;
    }

    .dark .copy-code-button {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .dark .copy-code-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Enhanced Prism.js theme integration and code block styling */

    /* Light mode - disable dark theme */
    :not(.dark) #prism-dark-theme {
      display: none;
    }

    /* Dark mode - disable light theme and apply dark styling */
    .dark #prism-light-theme {
      display: none;
    }

    /* Code block container styling */
    .code-block-container {
      background: #f8f9fa !important;
      border: 1px solid #e1e4e8 !important;
    }

    .dark .code-block-container {
      background: #1e1e1e !important;
      border: 1px solid #3e4651 !important;
    }

    /* Pre and code styling */
    .code-block-container pre {
      background: transparent !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
    }

    .code-block-container code {
      background: transparent !important;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace !important;
      font-size: 13px !important;
      line-height: 1.45 !important;
      display: block;
      padding: 16px !important;
      white-space: pre;
    }

    /* Base colors for non-highlighted code only */
    .code-block-container code:not([class*="language-"]) {
      color: #24292e;
    }

    .dark .code-block-container code:not([class*="language-"]) {
      color: #e1e4e8;
    }

    /* Enhanced scrollbar styling for code blocks */
    .code-block-container pre::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }

    .code-block-container pre::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    .code-block-container pre::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }

    .code-block-container pre::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.5);
    }

    .dark .code-block-container pre::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    .dark .code-block-container pre::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
    }

    .dark .code-block-container pre::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Remove conflicting dark mode token colors - let Prism.js themes handle syntax highlighting */

    /* Responsive header layout */
    @media (max-width: 768px) {
      .content-header {
        padding-right: 1.25rem !important;
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }

      #chat-dark-toggle {
        position: relative !important;
        top: auto !important;
        right: auto !important;
        align-self: flex-end;
        margin-top: -2rem;
      }

      .external-link {
        align-self: flex-end;
      }
    }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
</head>

<body class="bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-200 font-sans">

  <!-- Progress bar -->
  <div id="loading-overlay" class="fixed top-0 left-0 right-0 h-1 bg-gray-200 z-50 hidden">
    <div id="loading-bar" class="h-full bg-blue-500 transition-all duration-200"></div>
  </div>

  <!-- Upload wrapper -->
  <div id="upload-wrapper" class="flex justify-center items-center h-screen p-5">
    <div id="landing-dark-toggle" class="absolute top-5 right-5 flex items-center gap-2 text-sm">
      <span>Dark mode:</span>
      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" id="landing-dark-toggle-input" class="sr-only peer">
        <div
          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
        </div>
      </label>
    </div>

    <div id="upload-area"
      class="cursor-pointer border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-12 text-center max-w-lg w-full transition-all duration-300 bg-white dark:bg-slate-800 shadow-md hover:bg-blue-50 dark:hover:bg-slate-700 hover:border-blue-500 dark:hover:border-blue-500 hover:-translate-y-0.5 hover:shadow-xl">
      <h1 class="inline-flex items-center gap-3 text-2xl text-blue-600 dark:text-blue-400 mb-5">
        <i class="fas fa-comments text-3xl"></i>
        <span>LLM Chat Explorer</span>
      </h1>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Upload the export of your chat data from ChatGPT or Claude to view and analyze conversations in an intuitive and
        user-friendly interface.
      </p>
      <br>
      <p class="text-base text-gray-800 dark:text-gray-200 mt-2">Drag and drop JSON or ZIP files or click to select</p>
      <input type="file" id="json-file" accept=".json,.zip" multiple class="hidden">
    </div>
  </div>

  <!-- Main app -->
  <div class="app-container h-screen overflow-hidden hidden">
    <div id="chat-dark-toggle"
      class="absolute top-5 right-5 flex items-center gap-2 text-sm z-20 bg-white dark:bg-slate-800 px-2 py-1 rounded-md shadow-sm border border-gray-200 dark:border-slate-700">
      <span>Dark mode:</span>
      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" id="chat-dark-toggle-input" class="sr-only peer">
        <div
          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
        </div>
      </label>
    </div>
    <div class="flex h-full">
      <div
        class="sidebar bg-gray-50 dark:bg-slate-900 border-r border-gray-200 dark:border-slate-700 flex flex-col shadow-md">
        <div
          class="sidebar-header flex items-center justify-between p-5 border-b border-gray-200 dark:border-slate-700">
          <div class="sidebar-content">
            <h1 class="inline-flex items-center gap-3 text-lg text-blue-600 dark:text-blue-400 cursor-pointer"
              onclick="location.reload();" title="Click here to reload the page">
              <i class="fas fa-comments"></i> LLM Chat Explorer
            </h1>
          </div>
          <button id="sidebar-toggle"
            class="collapse-icon bg-transparent border-none cursor-pointer text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200"
            title="Toggle sidebar">
            <i class="fas fa-chevron-left sidebar-toggle"></i>
          </button>
        </div>
        <div class="sidebar-content">
          <div id="chat-counter"
            class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400 px-5 py-1">
            <div class="chat-info flex items-center gap-1.5">
              <i class="fas fa-chart-bar"></i>
              <span id="chat-counter-text">0 chats total</span>
            </div>
            <div id="service-label" class="ml-2.5 text-sm text-gray-500 dark:text-gray-400">Source:</div>
            <div id="open-settings" title="Open settings" class="cursor-pointer text-sm">
              <i class="fas fa-gear"></i>
            </div>
          </div>
        </div>

        <div class="sidebar-content">
          <div class="tab-container flex border-b border-gray-200 dark:border-slate-700">
            <button
              class="tab-button flex-1 p-2.5 text-sm text-gray-500 dark:text-gray-400 transition-all duration-200 hover:bg-gray-100 dark:hover:bg-slate-800 active"
              id="conversations-tab">
              <i class="fas fa-comments"></i> Conversations
            </button>
            <button
              class="tab-button flex-1 p-2.5 text-sm text-gray-500 dark:text-gray-400 transition-all duration-200 hover:bg-gray-100 dark:hover:bg-slate-800"
              id="projects-tab">
              <i class="fas fa-folder"></i> Projects
            </button>
          </div>
        </div>

        <div class="sidebar-content">
          <div id="conversations-content" class="tab-content flex-grow flex-col">
            <div class="search-container relative m-4">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="text" id="search-bar" placeholder="Search conversations..."
                class="w-full pl-10 pr-10 py-3 border border-gray-300 dark:border-gray-600 rounded-md text-sm transition-all duration-200 bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <span id="clear-search"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 cursor-pointer hidden w-5 h-5 leading-5 text-center rounded-full bg-gray-300 dark:bg-gray-500 hover:bg-gray-400 dark:hover:bg-gray-600">&times;</span>
            </div>
            <div class="search-options relative mx-4 text-xs pb-2.5 border-b border-gray-200 dark:border-slate-700">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-2">
                  <span>Search within message content:</span>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="search-content-toggle" class="sr-only peer">
                    <div
                      class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                    </div>
                  </label>
                </div>
                <select id="sort-chats"
                  class="bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-xs">
                  <option value="newest">Sort by Date (Newest First)</option>
                  <option value="oldest">Sort by Date (Oldest First)</option>
                </select>
              </div>
            </div>
            <ul id="chat-list"
              class="list-none overflow-y-auto flex-grow p-2.5 max-h-[calc(100vh-250px)] custom-scrollbar">
            </ul>
          </div>

          <div id="projects-content" class="tab-content flex-grow flex-col hidden">
            <div class="search-container relative m-4">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="text" id="project-search" placeholder="Search projects..."
                class="w-full pl-10 pr-10 py-3 border border-gray-300 dark:border-gray-600 rounded-md text-sm transition-all duration-200 bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <span id="clear-project-search"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 cursor-pointer hidden w-5 h-5 leading-5 text-center rounded-full bg-gray-300 dark:bg-gray-500 hover:bg-gray-400 dark:hover:bg-gray-600">&times;</span>
            </div>
            <ul id="project-list"
              class="list-none overflow-y-auto flex-grow p-2.5 max-h-[calc(100vh-250px)] custom-scrollbar">
            </ul>
          </div>
        </div>
      </div>
      <div class="content flex-grow flex flex-col overflow-hidden custom-scrollbar">
        <div
          class="content-header flex justify-between items-center p-5 border-b border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm pr-48">
          <div class="flex items-center gap-2 flex-1 min-w-0">
            <h2 id="chat-title" class="text-lg font-semibold m-0 truncate">Select a chat</h2>
            <button id="share-button" title="Share chat"
              class="bg-none border-none cursor-pointer text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
              <i class="fas fa-share"></i>
            </button>
          </div>
          <a id="chat-link" href="#" target="_blank"
            class="external-link hidden items-center gap-1.5 text-blue-600 dark:text-blue-300 no-underline text-sm transition-opacity duration-200 px-3 py-1.5 rounded-md bg-blue-50 dark:bg-slate-700 hover:opacity-80 whitespace-nowrap">
            <i class="fas fa-external-link-alt"></i> View on
          </a>
        </div>
        <div id="chat-content"
          class="chat-messages flex-grow overflow-y-auto p-5 bg-white dark:bg-slate-800 custom-scrollbar">
          <div
            class="empty-state flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400 text-center">
            <i class="fas fa-hand-point-left text-4xl mb-5"></i>
            <p class="text-base">Select a conversation from the list to view it</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Attachment content modal -->
  <div id="attachment-modal"
    class="hidden fixed z-50 left-0 top-0 w-full h-full overflow-auto bg-black/50 justify-center items-center">
    <div
      class="modal-content bg-white dark:bg-slate-800 p-5 rounded-md w-11/12 max-w-4xl max-h-[80vh] relative overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h2 id="attachment-modal-title" class="text-lg font-semibold text-blue-600 dark:text-blue-400">Attachment
          Content</h2>
        <span
          class="attachment-close-button text-2xl cursor-pointer text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</span>
      </div>
      <div id="attachment-modal-content"
        class="flex-1 overflow-auto custom-scrollbar bg-gray-50 dark:bg-slate-900 p-4 rounded border border-gray-200 dark:border-slate-700">
        <pre class="whitespace-pre-wrap text-sm text-gray-700 dark:text-gray-300"></pre>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settings-modal"
    class="hidden fixed z-50 left-0 top-0 w-full h-full overflow-auto bg-black/50 justify-center items-center">
    <div class="modal-content bg-white dark:bg-slate-800 p-5 rounded-md w-11/12 max-w-md relative">
      <span class="close-button absolute right-4 top-4 text-2xl cursor-pointer">&times;</span>
      <h2 class="mb-5 text-blue-600 dark:text-blue-400">Settings</h2>
      <div class="setting-item flex justify-between items-center mb-5">
        <span class="label text-base text-gray-800 dark:text-gray-200">Chat position:</span>
        <div class="flex items-center gap-3">
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="modal-chat-toggle" checked class="sr-only peer">
            <div
              class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
            </div>
          </label>
          <span id="chat-position-text" class="text-sm text-gray-600 dark:text-gray-400">At end</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // The Javascript from the original file remains the same.
    // I've only updated the HTML structure and classes for Tailwind CSS.
    // The original Javascript should work with the new structure.
    // ... (paste the entire <script> content from the original file here)
    // Function to format the date in dd/mm/yyyy format
    function formatDate(date) {
      const d = new Date(date);
      const day = ('0' + d.getDate()).slice(-2);
      const month = ('0' + (d.getMonth() + 1)).slice(-2);
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function processData(data) {
      let conversations = [];
      if (Array.isArray(data)) {
        conversations = data;
      } else {
        conversations = data.conversations || [];
      }

      // If the file is in Claude format (i.e., if the first object contains the property chat_messages), the order is from oldest to newest.
      // Reverse the array to have the same order (from most recent to oldest) as ChatGPT to normalize the chat flow display.
      if (conversations.length > 0 && conversations[0].chat_messages) {
        conversations.reverse();
      }

      // Save the original total globally for reference
      window.originalTotalChats = conversations.length;

      let chatListHTML = '';
      const chatData = {};
      let displayedChatIndex = 0;

      conversations.forEach((chat, originalIndex) => {
        // Skip chats with empty names - don't consider chats having "name": ""
        if ((chat.title === "" || chat.title === null || chat.title === undefined) &&
          (chat.name === "" || chat.name === null || chat.name === undefined)) {
          return; // Skip this chat
        }

        // Use 'title' (ChatGPT) or 'name' (Claude) for the title
        let title = chat.title || chat.name || `Chat ${displayedChatIndex + 1}`;
        let messages = [];
        let service = "ChatGPT"; // default
        let uuid = null;
        let conversation_id = null;

        // If the format is Claude (field "chat_messages")
        if (chat.chat_messages) {
          service = "Claude";
          uuid = chat.uuid; // from Claude
          chat.chat_messages.forEach((msg) => {
            // Map the role based on the sender field
            let role = "";
            if (msg.sender) {
              role = msg.sender === "human" ? "user" : "assistant";
            } else {
              role = "assistant"; // default
            }

            // For Claude messages, store the full message object for thinking content
            const messageObj = {
              text: msg.text || '',
              role: role,
              content: msg.content || [],
              attachments: msg.attachments || [],
              files: msg.files || [],
              isClaudeMessage: true
            };
            messages.push(messageObj);
          });
        }
        // If the format is ChatGPT with mapping
        else if (chat.mapping) {
          if (chat.conversation_id) {
            conversation_id = chat.conversation_id;
          }
          for (let key in chat.mapping) {
            const messageObj = chat.mapping[key];
            if (messageObj.message && messageObj.message.content) {
              // Extract the role from the author.role field (default to "assistant" if not present)
              const role = messageObj.message.author && messageObj.message.author.role ? messageObj.message.author.role : "assistant";
              const parts = messageObj.message.content.parts || [];
              parts.forEach((part) => {
                if (typeof part === 'string' && part.trim() !== '') {
                  messages.push({ text: part, role: role });
                }
              });
            }
          }
        }

        // Handle creation date (Claude uses "created_at")
        let createdTime = null;
        if (chat.created_at) {
          createdTime = new Date(chat.created_at);
        } else if (chat.create_time) {
          createdTime = typeof chat.create_time === 'number' ? new Date(chat.create_time * 1000) : new Date(chat.create_time);
        }

        chatListHTML += `<li data-id="${displayedChatIndex}" title="${title}" class="p-3.5 mb-1.5 cursor-pointer rounded-md transition-all duration-200 border-l-2 border-transparent text-sm hover:bg-gray-100 dark:hover:bg-slate-800 hover:border-blue-500"><div class="flex flex-col gap-1"><div class="font-medium truncate">${title}</div>${createdTime ? `<div class="text-gray-500 dark:text-gray-400 text-xs opacity-70">${formatDate(createdTime)}</div>` : ''}</div></li>`;
        chatData[displayedChatIndex] = {
          title: title,
          messages: messages,
          created_time: createdTime ? formatDate(createdTime) : "",
          service: service,
          uuid: uuid,
          conversation_id: conversation_id
        };
        displayedChatIndex++;
      });

      // Update the total chats count to reflect displayed chats
      window.totalChats = displayedChatIndex;

      document.getElementById("chat-list").innerHTML = chatListHTML;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        li.setAttribute("data-original", li.innerHTML);
      });
      if (conversations.length > 0) {
        // If the first object contains "chat_messages", the file is from Claude, otherwise ChatGPT
        let serviceType = (conversations[0].chat_messages) ? "Claude" : "ChatGPT";
        window.currentService = serviceType; // Save the service globally
        document.getElementById("service-label").textContent = "Source: " + serviceType;
      }
      const searchBar = document.getElementById("search-bar");
      const clearSearch = document.getElementById("clear-search");

      searchBar.addEventListener("input", () => {
        const searchTerm = searchBar.value.toLowerCase().trim();
        clearSearch.style.display = searchTerm !== "" ? "block" : "none";
        const words = searchTerm.split(/\s+/).filter(word => word.length > 0);
        const searchInContent = document.getElementById("search-content-toggle").checked;
        let visibleCount = 0; // variable to count visible chats

        Array.from(document.getElementById("chat-list").children).forEach(li => {
          const chatId = li.getAttribute("data-id");
          const chat = chatData[chatId];
          const titleText = chat.title.toLowerCase();
          // Check the title
          const titleMatches = words.every(word => titleText.includes(word));
          let contentMatches = false;
          if (searchInContent && chat.messages) {
            contentMatches = chat.messages.some(msgObj => {
              return words.every(word => msgObj.text.toLowerCase().includes(word));
            });
          }
          const matches = titleMatches || contentMatches;
          li.style.display = matches ? "" : "none";
          if (matches) {
            visibleCount++;
            // Highlight in the title (if applicable)
            if (titleMatches && words.length > 0) {
              let newHTML = li.getAttribute("data-original");
              words.forEach(word => {
                const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\\\]/g, '\\$&')})`, 'gi');
                newHTML = newHTML.replace(regex, `<span class="bg-yellow-200 dark:bg-yellow-800/70 text-gray-900 dark:text-yellow-100 px-1 rounded">$1</span>`);
              });
              li.innerHTML = newHTML;
            } else {
              li.innerHTML = li.getAttribute("data-original");
            }
          }
        });

        // Update the counter: "visible of total chats total"
        if (visibleCount === window.totalChats) {
          document.getElementById("chat-counter-text").textContent = window.totalChats + " chats total";
        } else {
          document.getElementById("chat-counter-text").textContent = visibleCount + " of " + window.totalChats + " chats total";
        }

        // If a chat is active, also update the message content
        const activeLi = document.querySelector(".chat-list li.active");
        if (activeLi) {
          const activeChatId = activeLi.getAttribute("data-id");
          renderMessages(chatData[activeChatId].messages);
        }
      });
      // Add this listener to update the search when the checkbox changes:
      document.getElementById("search-content-toggle").addEventListener("change", () => {
        // Simulate the "input" event on the search field to update the results
        searchBar.dispatchEvent(new Event("input"));
      });
      clearSearch.addEventListener("click", () => {
        searchBar.value = "";
        clearSearch.style.display = "none";
        Array.from(document.getElementById("chat-list").children).forEach(li => {
          li.style.display = "";
          li.innerHTML = li.getAttribute("data-original");
        });
        searchBar.focus();
        // Update the counter to show the total, as the filter has been removed
        document.getElementById("chat-counter-text").textContent = window.totalChats + " chats total";
      });
      document.getElementById("chat-list").addEventListener("click", (event) => {
        const clickedLi = event.target.closest("li");
        if (!clickedLi) return;
        Array.from(document.getElementById("chat-list").children).forEach(li => {
          li.classList.remove("active", "bg-blue-50", "dark:bg-slate-700", "border-blue-500", "font-semibold", "shadow-sm");
        });
        clickedLi.classList.add("active", "bg-blue-50", "dark:bg-slate-700", "border-blue-500", "font-semibold", "shadow-sm");
        const chatId = clickedLi.getAttribute("data-id");
        const chat = chatData[chatId];
        document.getElementById("chat-title").textContent = chat.title;
        const chatLink = document.getElementById("chat-link");
        if (chat.url) {
          chatLink.href = chat.url;
          chatLink.style.display = "inline-flex";
        } else {
          chatLink.style.display = "none";
        }
        if (chat.messages && chat.messages.length > 0) {
          renderMessages(chat.messages);
        } else {
          document.getElementById("chat-content").innerHTML = `
        <div class="empty-state flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400 text-center">
          <i class="fas fa-comment-slash text-4xl mb-5"></i>
          <p>Select a conversation from the list to view it</p>
        </div>`;
        }
      });
      function renderMessages(messages) {
        let html = '';
        messages.forEach((msgObj, msgIndex) => {
          const role = msgObj.role || "assistant"; // fallback
          if (role === "user") {
            html += `
          <div class="message message-user mb-6 p-5 rounded-xl shadow-sm ml-16 border border-gray-200 dark:border-slate-700 bg-blue-50 dark:bg-slate-700/50 border-l-4 border-blue-500">
            <div class="message-header flex items-center mb-2">
              <div class="avatar w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white mr-3 text-sm font-semibold shadow-sm" title="User">U</div>
              <span class="sender font-semibold text-sm">You</span>
            </div>
            <div class="message-content leading-relaxed">
              ${renderAttachments(msgObj)}
              ${formatMessage(msgObj.text)}
            </div>
          </div>`;
          } else {
            html += `
          <div class="message message-assistant mb-6 p-5 rounded-xl shadow-sm mr-16 border border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900/50">
            <div class="message-header flex items-center mb-2">
              <div class="avatar w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white mr-3 text-sm font-semibold shadow-sm" title="Assistant">A</div>
              <span class="sender font-semibold text-sm">${window.currentService}</span>
            </div>
            <div class="message-content leading-relaxed">
              ${renderAttachments(msgObj)}
              ${renderThinkingContent(msgObj, msgIndex)}
              ${formatMessage(getCleanedMessageText(msgObj))}
            </div>
          </div>`;
          }
        });
        document.getElementById("chat-content").innerHTML = html;

        // Add click handlers for thinking toggles
        document.querySelectorAll('.thinking-toggle').forEach(toggle => {
          toggle.addEventListener('click', () => {
            const content = toggle.nextElementSibling;
            const icon = toggle.querySelector('.thinking-icon');

            if (content.classList.contains('expanded')) {
              content.classList.remove('expanded', 'block');
              content.classList.add('hidden');
              icon.classList.remove('expanded', 'rotate-90');
            } else {
              content.classList.add('expanded', 'block');
              content.classList.remove('hidden');
              icon.classList.add('expanded', 'rotate-90');
            }
          });
        });

        // Add click handlers for attachment view buttons
        document.querySelectorAll('.view-attachment-btn').forEach(button => {
          button.addEventListener('click', () => {
            const filename = button.getAttribute('data-filename');
            const content = decodeURIComponent(button.getAttribute('data-content'));

            document.getElementById('attachment-modal-title').textContent = filename;
            document.querySelector('#attachment-modal-content pre').textContent = content;
            document.getElementById('attachment-modal').style.display = 'flex';
          });
        });

        // Add click handlers for project content view buttons
        document.querySelectorAll('.view-content-btn').forEach(button => {
          button.addEventListener('click', () => {
            const filename = button.getAttribute('data-filename');
            const content = decodeURIComponent(button.getAttribute('data-content'));

            document.getElementById('attachment-modal-title').textContent = filename;
            document.querySelector('#attachment-modal-content pre').textContent = content;
            document.getElementById('attachment-modal').style.display = 'flex';
          });
        });

        // Add click handlers for code copy buttons
        document.querySelectorAll('.copy-code-button').forEach(button => {
          button.addEventListener('click', (e) => {
            e.preventDefault();
            const codeId = button.getAttribute('data-code-id');
            const codeElement = document.getElementById(codeId);
            const codeText = codeElement.querySelector('code').textContent;

            navigator.clipboard.writeText(codeText).then(() => {
              // Create notification similar to the share button
              const notification = document.createElement("div");
              notification.textContent = "Code copied to clipboard!";
              notification.className = "fixed top-16 left-1/2 -translate-x-1/2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-5 py-2.5 rounded-md opacity-0 transition-opacity duration-1000 z-50";
              document.body.appendChild(notification);

              // Show notification
              setTimeout(() => {
                notification.style.opacity = "1";
              }, 10);

              // Hide and remove notification
              setTimeout(() => {
                notification.style.opacity = "0";
                setTimeout(() => {
                  if (notification.parentNode) {
                    document.body.removeChild(notification);
                  }
                }, 1000);
              }, 2000);

              // Update button text temporarily
              const originalText = button.innerHTML;
              button.innerHTML = '<i class="fas fa-check"></i> Copied!';
              setTimeout(() => {
                button.innerHTML = originalText;
              }, 1500);

            }).catch(err => {
              console.error("Error copying code: " + err);
            });
          });
        });

        // Apply Prism.js syntax highlighting with error handling
        if (typeof Prism !== 'undefined') {
          try {
            // Use a small delay to ensure DOM is ready
            setTimeout(() => {
              // Highlight all code blocks
              Prism.highlightAll();

              // Also highlight any manually created elements
              document.querySelectorAll('pre code[class*="language-"]:not(.highlighted)').forEach(element => {
                element.classList.add('highlighted');
                Prism.highlightElement(element);
              });
            }, 50);
          } catch (error) {
            console.warn('Prism.js highlighting failed:', error);
          }
        }

        const scrollPreference = localStorage.getItem('chatPosition') || 'end';
        const chatContent = document.getElementById("chat-content");
        chatContent.scrollTop = scrollPreference === 'end' ? chatContent.scrollHeight : 0;
      }

      function getCleanedMessageText(msgObj) {
        if (!msgObj.isClaudeMessage || !msgObj.content) return msgObj.text || '';

        // Find thinking content to remove from text
        const thinkingContent = msgObj.content.find(c => c.type === 'thinking');
        if (!thinkingContent) return msgObj.text || '';

        let cleanedText = msgObj.text || '';
        const thinkingText = thinkingContent.thinking || '';

        // Remove thinking content from the beginning of the text if it exists
        if (thinkingText && cleanedText.startsWith(thinkingText)) {
          cleanedText = cleanedText.substring(thinkingText.length).trim();
        }

        return cleanedText;
      }

      function renderAttachments(msgObj) {
        if (!msgObj.attachments && !msgObj.files) return '';

        const attachments = msgObj.attachments || [];
        const files = msgObj.files || [];
        // Combine and deduplicate based on filename
        const allFiles = [];
        const seen = new Set();

        [...attachments, ...files].forEach(file => {
          const filename = file.file_name || file.filename || 'Unknown file';
          if (!seen.has(filename)) {
            seen.add(filename);
            allFiles.push(file);
          }
        });

        if (allFiles.length === 0) return '';

        return `
          <div class="attachments-section mb-3 border border-gray-200 dark:border-slate-700 rounded-md bg-gray-50 dark:bg-slate-800/50 p-3">
            <div class="flex items-center gap-2 mb-2">
              <i class="fas fa-paperclip text-gray-500 dark:text-gray-400"></i>
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${allFiles.length} attachment${allFiles.length > 1 ? 's' : ''}</span>
            </div>
            ${allFiles.map((file, index) => `
              <div class="attachment-item p-2 bg-white dark:bg-slate-700 rounded border border-gray-200 dark:border-slate-600 mb-2 last:mb-0">
                <div class="flex items-center gap-2">
                  <i class="fas fa-file-alt text-blue-500 dark:text-blue-400"></i>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm text-gray-800 dark:text-gray-200 truncate">${file.file_name || file.filename || 'Unknown file'}</div>
                    ${file.file_size ? `<div class="text-xs text-gray-500 dark:text-gray-400">${(file.file_size / 1024).toFixed(1)} KB</div>` : ''}
                    ${file.file_type ? `<div class="text-xs text-gray-500 dark:text-gray-400 capitalize">${file.file_type}</div>` : ''}
                  </div>
                </div>
                ${file.extracted_content ? `
                  <button class="view-attachment-btn mt-2 px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors duration-200" 
                          data-filename="${file.file_name || file.filename || 'Unknown file'}" 
                          data-content="${encodeURIComponent(file.extracted_content)}">
                    View content
                  </button>
                ` : ''}
              </div>
            `).join('')}
          </div>
        `;
      }

      function renderThinkingContent(msgObj, msgIndex) {
        if (!msgObj.isClaudeMessage || !msgObj.content) return '';

        // Find thinking content
        const thinkingContent = msgObj.content.find(c => c.type === 'thinking');
        if (!thinkingContent) return '';

        return `
          <div class="thinking-section mb-3 border border-gray-200 dark:border-slate-700 rounded-lg bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 overflow-hidden shadow-sm">
            <button class="thinking-toggle p-3 bg-gradient-to-r from-purple-100 to-indigo-100 dark:from-purple-800/30 dark:to-indigo-800/30 border-none cursor-pointer text-sm text-purple-700 dark:text-purple-300 flex items-center gap-2 w-full text-left hover:from-purple-200 hover:to-indigo-200 dark:hover:from-purple-700/40 dark:hover:to-indigo-700/40 transition-all duration-200">
              <i class="fas fa-chevron-right thinking-icon transition-transform duration-200 text-purple-600 dark:text-purple-400"></i>
              <span class="flex items-center gap-2">
                <span class="text-lg">🧠</span>
                <span class="font-medium">Show Thinking Process</span>
                <span class="ml-auto text-xs opacity-75 bg-purple-200 dark:bg-purple-800 px-2 py-1 rounded-full">Internal reasoning</span>
              </span>
            </button>
            <div class="thinking-content p-4 text-sm text-gray-700 dark:text-gray-300 leading-relaxed bg-white/50 dark:bg-slate-800/50 hidden">
              <div class="border-l-4 border-purple-400 dark:border-purple-500 pl-4">
                ${formatMessage(thinkingContent.thinking || '')}
              </div>
            </div>
          </div>
        `;
      }
      function formatMessage(text) {
        if (!text) return '';

        // Escape HTML first to prevent injection, but preserve our markdown
        text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        // Enhanced markdown support with improved formatting
        // Code blocks (must come before inline code) - improved language detection with Prism.js
        text = text.replace(/```([a-zA-Z0-9_+-]*)\n?([\s\S]*?)```/g, (match, lang, code) => {
          // Enhanced language mapping and validation
          const languageMap = {
            'js': 'javascript', 'jsx': 'javascript', 'mjs': 'javascript',
            'py': 'python', 'py3': 'python', 'pyw': 'python',
            'ts': 'typescript', 'tsx': 'typescript',
            'sh': 'bash', 'zsh': 'bash', 'fish': 'bash', 'ps1': 'powershell',
            'c++': 'cpp', 'cxx': 'cpp', 'cc': 'cpp', 'h': 'cpp', 'hpp': 'cpp',
            'c#': 'csharp', 'cs': 'csharp',
            'rb': 'ruby', 'gemfile': 'ruby',
            'yml': 'yaml', 'dockerfile': 'docker',
            'md': 'markdown', 'mdx': 'markdown',
            'scss': 'css', 'sass': 'css', 'less': 'css', 'styl': 'css',
            'vim': 'viml', 'vimrc': 'viml'
          };

          const validLanguages = ['javascript', 'python', 'java', 'cpp', 'c', 'csharp', 'php', 'ruby', 'go', 'rust', 'swift', 'kotlin', 'typescript', 'html', 'css', 'scss', 'sql', 'bash', 'shell', 'powershell', 'json', 'xml', 'yaml', 'markdown', 'r', 'matlab', 'scala', 'perl', 'lua', 'dart', 'haskell', 'clojure', 'elixir', 'elm', 'fsharp', 'ocaml', 'scheme', 'racket', 'erlang', 'prolog', 'docker', 'nginx', 'apache', 'ini', 'toml', 'graphql', 'regex', 'viml', 'makefile', 'cmake', 'diff', 'git'];

          // Normalize language identifier
          const normalizedLang = lang ? lang.toLowerCase().trim() : '';
          const mappedLang = languageMap[normalizedLang] || normalizedLang;
          const isValidLang = mappedLang && validLanguages.includes(mappedLang);

          // Generate language class and label
          const langClass = isValidLang ? `language-${mappedLang}` : 'language-none';
          const displayLang = lang || 'code';
          const langLabel = isValidLang ? `<div class="flex justify-between items-center mb-2 px-1"><span class="text-xs text-gray-500 dark:text-gray-400 font-mono bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded">${displayLang}</span></div>` : '';

          // Generate unique ID for copy functionality
          const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
          const trimmedCode = code.trim();

          return `<div class="code-block-container rounded-lg my-4 shadow-sm">${langLabel}<button class="copy-code-button" data-code-id="${codeId}" title="Copy code"><i class="fas fa-copy"></i> Copy</button><pre id="${codeId}" class="${isValidLang ? langClass : ''}"><code class="${langClass}">${trimmedCode}</code></pre></div>`;
        });

        // Inline code - improved styling to prevent underscore issues
        text = text.replace(/`([^`]+)`/g, '<code class="bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded text-sm font-mono border border-gray-200 dark:border-slate-600 text-red-600 dark:text-red-400">$1</code>');

        // Bold text - improved regex to handle edge cases
        text = text.replace(/\*\*([^\*\n]+)\*\*/g, '<strong class="font-semibold text-gray-900 dark:text-gray-100">$1</strong>');
        text = text.replace(/__([^_\n]+)__/g, '<strong class="font-semibold text-gray-900 dark:text-gray-100">$1</strong>');

        // Italic text - improved to prevent conflicts with underscores in code/variables
        // Only apply italic if the underscore is surrounded by spaces or word boundaries and is not part of a larger word
        text = text.replace(/(?<!\w)\*([^\*\n]+)\*(?!\w)/g, '<em class="italic text-gray-800 dark:text-gray-200">$1</em>');
        text = text.replace(/(?<!\w)_([^_\n\s]+(?:\s+[^_\n\s]+)*)_(?!\w)/g, '<em class="italic text-gray-800 dark:text-gray-200">$1</em>');

        // Headers with improved spacing and typography
        text = text.replace(/^### (.+)$/gm, '<h3 class="text-lg font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">$1</h3>');
        text = text.replace(/^## (.+)$/gm, '<h2 class="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100 border-b-2 border-gray-300 dark:border-gray-600 pb-2">$1</h2>');
        text = text.replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold mt-8 mb-6 text-gray-900 dark:text-gray-50 border-b-2 border-blue-500 pb-3">$1</h1>');

        // Improved lists with better nesting and spacing
        text = text.replace(/^([ \t]*)([-*+]) (.+)$/gm, (match, indent, marker, content) => {
          const level = Math.floor(indent.length / 2);
          const marginClass = level > 0 ? `ml-${Math.min(level * 4, 12)}` : 'ml-0';
          return `<li class="${marginClass} list-disc list-inside mb-1 leading-relaxed">${content}</li>`;
        });

        // Wrap consecutive list items in ul tags
        text = text.replace(/(<li[^>]*>.*?<\/li>)(\s*<li[^>]*>.*?<\/li>)*/gs, '<ul class="my-4 space-y-1 pl-4">$&</ul>');

        // Ordered lists
        text = text.replace(/^([ \t]*)(\d+)\. (.+)$/gm, (match, indent, num, content) => {
          const level = Math.floor(indent.length / 2);
          const marginClass = level > 0 ? `ml-${Math.min(level * 4, 12)}` : 'ml-0';
          return `<li class="${marginClass} list-decimal list-inside mb-1 leading-relaxed">${content}</li>`;
        });

        // Tables - basic support
        text = text.replace(/^\|(.+)\|\s*$/gm, (match, content) => {
          const cells = content.split('|').map(cell => cell.trim());
          const cellsHtml = cells.map(cell => `<td class="px-3 py-2 border border-gray-300 dark:border-gray-600">${cell}</td>`).join('');
          return `<tr>${cellsHtml}</tr>`;
        });
        text = text.replace(/(<tr>.*?<\/tr>)(\s*<tr>.*?<\/tr>)*/gs, '<table class="min-w-full border-collapse border border-gray-300 dark:border-gray-600 my-4 rounded-lg overflow-hidden">$&</table>');

        // Links with improved styling
        text = text.replace(/(https?:\/\/[^\s&lt;&gt;\)]+)/g, '<a href="$1" target="_blank" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 underline decoration-blue-500 underline-offset-2 transition-colors">$1</a>');

        // Blockquotes with enhanced styling
        text = text.replace(/^&gt; (.+)$/gm, '<blockquote class="border-l-4 border-blue-400 dark:border-blue-500 pl-4 my-4 italic text-gray-700 dark:text-gray-300 bg-blue-50 dark:bg-blue-900/20 py-3 rounded-r-lg">$1</blockquote>');

        // Horizontal rules
        text = text.replace(/^---+$/gm, '<hr class="my-6 border-0 h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent">');

        // Strikethrough
        text = text.replace(/~~([^~]+)~~/g, '<del class="line-through text-gray-500 dark:text-gray-400">$1</del>');

        // Protect code blocks and inline code before processing paragraphs and line breaks
        const codeBlocks = [];
        const inlineCode = [];

        // Protect code block containers first
        text = text.replace(/<div class="code-block-container[^>]*>.*?<\/div>/gs, (match) => {
          const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
          codeBlocks.push(match);
          return placeholder;
        });

        // Protect inline code elements
        text = text.replace(/<code[^>]*>.*?<\/code>/gs, (match) => {
          const placeholder = `__INLINE_CODE_${inlineCode.length}__`;
          inlineCode.push(match);
          return placeholder;
        });

        // Convert paragraphs with improved line height and spacing
        text = text.replace(/\n\n+/g, '</p><p class="mb-4 leading-relaxed text-gray-800 dark:text-gray-200">');
        text = '<p class="mb-4 leading-relaxed text-gray-800 dark:text-gray-200">' + text + '</p>';

        // Convert single newlines to line breaks only in regular content (code is protected)
        text = text.replace(/(?<!<\/[^>]+>)\n(?!<[^>]+>)/g, '<br>');

        // Restore inline code first
        inlineCode.forEach((code, index) => {
          text = text.replace(`__INLINE_CODE_${index}__`, code);
        });

        // Restore code blocks
        codeBlocks.forEach((block, index) => {
          text = text.replace(`__CODE_BLOCK_${index}__`, block);
        });

        // Clean up empty paragraphs and improve formatting
        text = text.replace(/<p class="[^"]*"><\/p>/g, '');
        text = text.replace(/<p class="[^"]*">\s*<\/p>/g, '');

        // Highlight searched words in the content if the checkbox is active
        const searchTerm = document.getElementById("search-bar")?.value.toLowerCase().trim();
        const searchInContent = document.getElementById("search-content-toggle")?.checked;
        if (searchTerm && searchInContent) {
          const words = searchTerm.split(/\s+/).filter(word => word.length > 0);
          words.forEach(word => {
            const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\\\]/g, '\\$&')})`, 'gi');
            text = text.replace(regex, `<span class="bg-yellow-200 dark:bg-yellow-800/70 text-gray-900 dark:text-yellow-100 px-1 rounded">$1</span>`);
          });
        }
        return text;
      }

      // Update the chat counter if defined
      document.getElementById("chat-counter-text").textContent = window.totalChats + " chats total";

      document.getElementById("sort-chats").addEventListener("change", (event) => {
        sortConversations(event.target.value, chatData);
      });

      attachChatListClickHandler(chatData);
    }

    function sortConversations(order, chatData) {
      const chatList = document.getElementById("chat-list");
      const items = Array.from(chatList.children);

      items.sort((a, b) => {
        const chatA = chatData[a.getAttribute("data-id")];
        const chatB = chatData[b.getAttribute("data-id")];

        const dateA = new Date(chatA.created_time.split('/').reverse().join('-'));
        const dateB = new Date(chatB.created_time.split('/').reverse().join('-'));

        if (order === 'newest') {
          return dateB - dateA;
        } else {
          return dateA - dateB;
        }
      });

      items.forEach(item => chatList.appendChild(item));
    }

    function attachChatListClickHandler(chatData) {
      document.getElementById("chat-list").addEventListener("click", (event) => {
        const clickedLi = event.target.closest("li");
        if (!clickedLi) return;
        Array.from(document.getElementById("chat-list").children).forEach(li => {
          li.classList.remove("active", "bg-blue-50", "dark:bg-slate-700", "border-blue-500", "font-semibold", "shadow-sm");
        });
        clickedLi.classList.add("active", "bg-blue-50", "dark:bg-slate-700", "border-blue-500", "font-semibold", "shadow-sm");
        const chatId = clickedLi.getAttribute("data-id");
        const chat = chatData[chatId];
        document.getElementById("chat-title").textContent = chat.title;
        const chatLink = document.getElementById("chat-link");

        // Only show the link if there are messages
        if (chat.messages && chat.messages.length > 0) {
          if (chat.service === "Claude" && chat.uuid) {
            chatLink.href = "https://claude.ai/chat/" + chat.uuid;
            chatLink.innerHTML = '<i class="fas fa-external-link-alt"></i> View on Claude';
            chatLink.style.display = "inline-flex";
          } else if (chat.service === "ChatGPT" && chat.conversation_id) {
            chatLink.href = "https://chat.openai.com/c/" + chat.conversation_id;
            chatLink.innerHTML = '<i class="fas fa-external-link-alt"></i> View on ChatGPT';
            chatLink.style.display = "inline-flex";
          } else {
            chatLink.style.display = "none";
          }
        } else {
          chatLink.style.display = "none";
        }

        if (chat.messages && chat.messages.length > 0) {
          renderMessages(chat.messages);
        } else {
          document.getElementById("chat-content").innerHTML = `
        <div class="empty-state flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400 text-center">
          <i class="fas fa-comment-slash text-4xl mb-5"></i>
          <p>Select a conversation from the list to view it</p>
        </div>`;
        }
      });
    }

    // Process ZIP file and extract JSON files
    async function processZipFile(file) {
      try {
        const zip = new JSZip();
        const zipContents = await zip.loadAsync(file);

        let conversations = [];
        let projects = [];

        // Look for conversations.json and projects.json files
        for (const filename in zipContents.files) {
          const zipFile = zipContents.files[filename];

          if (filename.endsWith('conversations.json') && !zipFile.dir) {
            const content = await zipFile.async('text');
            const data = JSON.parse(content);
            if (Array.isArray(data)) {
              conversations = conversations.concat(data);
            } else {
              conversations.push(data);
            }
          } else if (filename.endsWith('projects.json') && !zipFile.dir) {
            const content = await zipFile.async('text');
            const data = JSON.parse(content);
            if (Array.isArray(data)) {
              projects = projects.concat(data);
            } else {
              projects.push(data);
            }
          }
        }

        return { conversations, projects };
      } catch (e) {
        throw new Error("Error processing ZIP file: " + e.message);
      }
    }

    // Handle the uploaded files (via input or drag & drop)
    async function handleFiles(files) {
      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingBar = document.getElementById('loading-bar');
      loadingOverlay.style.display = 'block';

      try {
        let allConversations = [];
        let allProjects = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          loadingBar.style.width = Math.floor((i / files.length) * 100) + '%';

          if (file.name.endsWith('.zip')) {
            const { conversations, projects } = await processZipFile(file);
            allConversations = allConversations.concat(conversations);
            allProjects = allProjects.concat(projects);
          } else if (file.name.endsWith('.json')) {
            const text = await file.text();
            const data = JSON.parse(text);

            // Detect format and add to appropriate array
            if (Array.isArray(data)) {
              allConversations = allConversations.concat(data);
            } else if (data.chat_messages) {
              // Single Claude conversation
              allConversations.push(data);
            } else if (data.conversations) {
              // ChatGPT format
              allConversations = allConversations.concat(data.conversations);
            } else {
              // Assume single conversation
              allConversations.push(data);
            }
          }
        }

        // Store projects globally for later use
        window.allProjects = allProjects;

        document.getElementById('upload-wrapper').style.display = 'none';
        document.querySelector('.app-container').style.display = 'flex';
        loadingOverlay.style.display = 'none';

        processData(allConversations);
        renderProjects();

      } catch (e) {
        alert("File processing error: " + e.message);
        loadingOverlay.style.display = 'none';
      }
    }

    // Tab switching functionality - improved for sidebar stability
    function switchTab(tabName) {
      const sidebar = document.querySelector('.sidebar');
      const currentWidth = sidebar.offsetWidth;

      // Temporarily disable transitions to prevent width flickering
      sidebar.style.transition = 'none';

      // Remove active class from all tabs and content
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active', 'text-blue-600', 'dark:text-blue-400', 'border-b-2', 'border-blue-500'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

      // Add active class to clicked tab and corresponding content
      const tabButton = document.getElementById(tabName + '-tab');
      tabButton.classList.add('active', 'text-blue-600', 'dark:text-blue-400', 'border-b-2', 'border-blue-500');
      document.getElementById(tabName + '-content').classList.remove('hidden');

      // Restore transitions after a brief delay
      setTimeout(() => {
        sidebar.style.transition = '';
      }, 50);
    }

    // Render projects list
    function renderProjects() {
      const projectList = document.getElementById('project-list');
      if (!window.allProjects || window.allProjects.length === 0) {
        projectList.innerHTML = '<li class="p-5 text-center text-gray-500 dark:text-gray-400">No projects found</li>';
        return;
      }

      let html = '';
      window.allProjects.forEach((project, index) => {
        const name = project.name || `Project ${index + 1}`;
        const description = project.description || '';
        const createdDate = project.created_at ? formatDate(new Date(project.created_at)) : '';

        html += `
          <li class="project-item p-3 mb-1.5 cursor-pointer rounded-md transition-all duration-200 border-l-2 border-transparent hover:bg-gray-100 dark:hover:bg-slate-800 hover:border-blue-500" data-project-id="${index}">
            <div class="project-name font-semibold">${name}</div>
            ${description ? `<div class="project-description text-xs text-gray-500 dark:text-gray-400 opacity-80">${description}</div>` : ''}
            ${createdDate ? `<div class="project-date text-xs text-gray-500 dark:text-gray-400 mt-1">${createdDate}</div>` : ''}
          </li>
        `;
      });

      projectList.innerHTML = html;

      // Store original HTML for search functionality
      Array.from(projectList.children).forEach(li => {
        li.setAttribute("data-original", li.innerHTML);
      });

      // Add click handlers for projects
      projectList.addEventListener('click', (e) => {
        const projectItem = e.target.closest('.project-item');
        if (!projectItem) return;

        // Remove active class from other projects
        document.querySelectorAll('.project-item').forEach(item => item.classList.remove('active', 'bg-blue-50', 'dark:bg-slate-700', 'border-blue-500'));
        projectItem.classList.add('active', 'bg-blue-50', 'dark:bg-slate-700', 'border-blue-500');

        const projectId = projectItem.getAttribute('data-project-id');
        displayProject(window.allProjects[projectId]);
      });

      // Add project search functionality
      setupProjectSearch();
    }

    // Display project details in the main content area
    function displayProject(project) {
      const chatTitle = document.getElementById('chat-title');
      const chatContent = document.getElementById('chat-content');
      const chatLink = document.getElementById('chat-link');

      chatTitle.textContent = project.name || 'Project';
      chatLink.style.display = 'none';

      let html = `
        <div class="p-5">
          <h3 class="text-xl font-semibold">Project: ${project.name || 'Unnamed Project'}</h3>
          ${project.description ? `<p class="my-2.5 text-gray-500 dark:text-gray-400">${project.description}</p>` : ''}
          ${project.created_at ? `<p class="my-2.5 text-sm text-gray-500 dark:text-gray-400">Created: ${formatDate(new Date(project.created_at))}</p>` : ''}
          
          ${project.prompt_template ? `
            <div class="my-5">
              <h4 class="font-semibold">Prompt Template:</h4>
              <div class="bg-gray-50 dark:bg-slate-900 p-4 rounded-md my-2.5 whitespace-pre-wrap font-mono">${project.prompt_template}</div>
            </div>
          ` : ''}
          
          ${project.docs && project.docs.length > 0 ? `
            <div class="my-5">
              <h4 class="font-semibold">Documents (${project.docs.length}):</h4>
              ${project.docs.map(doc => `
                <div class="border border-gray-200 dark:border-slate-700 rounded-md my-2.5 p-4">
                  <h5 class="m-0 mb-2.5 font-semibold">${doc.filename || 'Unnamed Document'}</h5>
                  ${doc.created_at ? `<p class="text-xs text-gray-500 dark:text-gray-400 my-1.5">Created: ${formatDate(new Date(doc.created_at))}</p>` : ''}
                  ${doc.content ? `
                    <button class="view-content-btn mt-2 px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors duration-200" 
                            data-filename="${doc.filename || 'Document'}" 
                            data-content="${encodeURIComponent(doc.content)}">
                      View Content
                    </button>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;

      chatContent.innerHTML = html;

      // Add click handlers for project content view buttons
      document.querySelectorAll('.view-content-btn').forEach(button => {
        button.addEventListener('click', () => {
          const filename = button.getAttribute('data-filename');
          const content = decodeURIComponent(button.getAttribute('data-content'));

          document.getElementById('attachment-modal-title').textContent = filename;
          document.querySelector('#attachment-modal-content pre').textContent = content;
          document.getElementById('attachment-modal').style.display = 'flex';
        });
      });
    }

    // Setup project search functionality
    function setupProjectSearch() {
      const projectSearchBar = document.getElementById("project-search");
      const clearProjectSearch = document.getElementById("clear-project-search");

      projectSearchBar.addEventListener("input", () => {
        const searchTerm = projectSearchBar.value.toLowerCase().trim();
        clearProjectSearch.style.display = searchTerm !== "" ? "block" : "none";
        const words = searchTerm.split(/\s+/).filter(word => word.length > 0);

        Array.from(document.getElementById("project-list").children).forEach(li => {
          const projectId = li.getAttribute("data-project-id");
          if (projectId !== null && window.allProjects && window.allProjects[projectId]) {
            const project = window.allProjects[projectId];
            const nameText = (project.name || '').toLowerCase();
            const descriptionText = (project.description || '').toLowerCase();

            // Check if search terms match name or description
            const matches = words.every(word =>
              nameText.includes(word) || descriptionText.includes(word)
            );

            li.style.display = matches ? "" : "none";

            if (matches && words.length > 0) {
              // Highlight matching terms
              let newHTML = li.getAttribute("data-original");
              words.forEach(word => {
                const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\\\]/g, '\\$&')})`, 'gi');
                newHTML = newHTML.replace(regex, `<span class="bg-yellow-200 dark:bg-yellow-800/70 text-gray-900 dark:text-yellow-100 px-1 rounded">$1</span>`);
              });
              li.innerHTML = newHTML;
            } else {
              li.innerHTML = li.getAttribute("data-original");
            }
          }
        });
      });

      clearProjectSearch.addEventListener("click", () => {
        projectSearchBar.value = "";
        clearProjectSearch.style.display = "none";
        Array.from(document.getElementById("project-list").children).forEach(li => {
          li.style.display = "";
          li.innerHTML = li.getAttribute("data-original");
        });
        projectSearchBar.focus();
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const uploadArea = document.getElementById('upload-area');
      const jsonFileInput = document.getElementById('json-file');

      // Tab switching
      document.getElementById('conversations-tab').addEventListener('click', () => switchTab('conversations'));
      document.getElementById('projects-tab').addEventListener('click', () => switchTab('projects'));

      uploadArea.addEventListener("click", () => {
        jsonFileInput.click();
      });
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add('hover');
      });
      uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadArea.classList.remove('hover');
      });
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove('hover');
        const files = e.dataTransfer.files;
        if (files.length) {
          handleFiles(Array.from(files));
        }
      });
      jsonFileInput.addEventListener("change", (e) => {
        if (e.target.files.length) {
          handleFiles(Array.from(e.target.files));
        }
      });
      // Modal: close by clicking the X
      document.querySelector("#settings-modal .close-button").addEventListener("click", () => {
        document.getElementById("settings-modal").style.display = "none";
      });

      // Attachment modal: close by clicking the X
      document.querySelector("#attachment-modal .attachment-close-button").addEventListener("click", () => {
        document.getElementById("attachment-modal").style.display = "none";
      });

      // Close modals by clicking outside
      document.getElementById("attachment-modal").addEventListener("click", (e) => {
        if (e.target.id === "attachment-modal") {
          document.getElementById("attachment-modal").style.display = "none";
        }
      });
      // Open modal from settings
      document.getElementById("open-settings").addEventListener("click", () => {
        document.getElementById("settings-modal").style.display = "flex";
      });
      // Toggle dark mode in chat page
      document.getElementById("chat-dark-toggle-input").addEventListener("change", (e) => {
        if (e.target.checked) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('darkMode', 'true');
          const landingToggle = document.getElementById("landing-dark-toggle-input");
          if (landingToggle) landingToggle.checked = true;
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('darkMode', 'false');
          const landingToggle = document.getElementById("landing-dark-toggle-input");
          if (landingToggle) landingToggle.checked = false;
        }
        // Re-highlight code blocks with new theme
        if (typeof Prism !== 'undefined') {
          try {
            // Clear existing highlighting and re-apply with new theme
            document.querySelectorAll('pre code[class*="language-"]').forEach(codeElement => {
              // Remove old highlighting classes
              codeElement.classList.remove('highlighted');
              // Re-highlight with new theme
              Prism.highlightElement(codeElement);
            });
            // Ensure all code blocks are re-highlighted after theme change
            setTimeout(() => {
              Prism.highlightAll();
            }, 200);
          } catch (error) {
            console.warn('Prism.js re-highlighting failed during theme change:', error);
          }
        }
      });
      // Toggle chat position in modal
      document.getElementById("modal-chat-toggle").addEventListener("change", (e) => {
        if (e.target.checked) {
          localStorage.setItem('chatPosition', 'end');
        } else {
          localStorage.setItem('chatPosition', 'start');
        }
        document.getElementById("chat-position-text").textContent = e.target.checked ? "At end" : "At start";
        // If a chat is already displayed, update the scroll
        const chatContent = document.getElementById("chat-content");
        chatContent.scrollTop = e.target.checked ? chatContent.scrollHeight : 0;
      });
      // Set saved settings from localStorage
      if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
        document.getElementById("chat-dark-toggle-input").checked = true;
        const landingToggle = document.getElementById("landing-dark-toggle-input");
        if (landingToggle) landingToggle.checked = true;
      }
      if (localStorage.getItem('chatPosition') === 'end') {
        document.getElementById("modal-chat-toggle").checked = true;
        document.getElementById("chat-position-text").textContent = "At end";
      } else {
        document.getElementById("modal-chat-toggle").checked = false;
        document.getElementById("chat-position-text").textContent = "At start";
      }

      // Landing page dark mode toggle
      document.getElementById("landing-dark-toggle-input").addEventListener("change", (e) => {
        if (e.target.checked) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('darkMode', 'true');
          const chatToggle = document.getElementById("chat-dark-toggle-input");
          if (chatToggle) chatToggle.checked = true;
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('darkMode', 'false');
          const chatToggle = document.getElementById("chat-dark-toggle-input");
          if (chatToggle) chatToggle.checked = false;
        }
        // Re-highlight code blocks with new theme
        if (typeof Prism !== 'undefined') {
          try {
            // Clear existing highlighting and re-apply with new theme
            document.querySelectorAll('pre code[class*="language-"]').forEach(codeElement => {
              // Remove old highlighting classes
              codeElement.classList.remove('highlighted');
              // Re-highlight with new theme
              Prism.highlightElement(codeElement);
            });
            // Ensure all code blocks are re-highlighted after theme change
            setTimeout(() => {
              Prism.highlightAll();
            }, 200);
          } catch (error) {
            console.warn('Prism.js re-highlighting failed during theme change:', error);
          }
        }
      });

      // Sidebar toggle functionality
      document.getElementById("sidebar-toggle").addEventListener("click", () => {
        const sidebar = document.querySelector('.sidebar');
        const isCollapsed = sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', isCollapsed.toString());
      });

      // Restore sidebar state from localStorage
      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        document.querySelector('.sidebar').classList.add('collapsed');
      }
    });

    // Event for the share button: copy the chat title + ChatGPT/Claude link to clipboard
    document.getElementById("share-button").addEventListener("click", function () {
      const chatTitle = document.getElementById("chat-title").textContent;
      const chatLink = document.getElementById("chat-link").href;
      // Add a colon and a space between title and link
      const shareText = chatTitle + ": " + chatLink;
      navigator.clipboard.writeText(shareText).then(() => {
        // Create a small light gray message that appears and fades out slowly
        const notification = document.createElement("div");
        notification.id = "copy-notification";
        notification.textContent = "Chat link copied to clipboard!";
        notification.className = "fixed top-16 left-1/2 -translate-x-1/2 bg-gray-300 text-gray-800 px-5 py-2.5 rounded-md opacity-0 transition-opacity duration-1000";
        document.body.appendChild(notification);
        // Make the message appear
        setTimeout(() => {
          notification.style.opacity = "1";
        }, 10);
        // After 2 seconds, fade out and remove the element
        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 1000);
        }, 2000);
      }).catch(err => {
        console.error("Error copying information: " + err);
      });
    });
  </script>
</body>

</html>